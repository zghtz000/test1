graph TD
  A[用户输入] --> B[入口点选择]
  B -->|人像模式命令行| C1[inference.py]
  B -->|动物模式命令行| C2[inference_animals.py]
  B -->|人像界面模式| C3[app.py]
  B -->|动物界面模式| C4[app_animals.py]
  
  C1 --> D[配置加载与初始化]
  C2 --> D
  C3 --> D
  C4 --> D
  
  D --> E[检查FFmpeg]
  E -->|未安装| E1[报错: FFmpeg未安装]
  E -->|已安装| F[参数验证]
  
  F -->|参数无效| F1[报错: 参数无效]
  F -->|参数有效| G[初始化Pipeline]
  G -->|人像模式| G1[LivePortraitPipeline]
  G -->|动物模式| G2[LivePortraitPipelineAnimal]
  
  G1 --> H[加载预训练模型]
  G2 --> H
  H --> H1[特征提取器F]
  H --> H2[动作提取器M]
  H --> H3[变形模块W]
  H --> H4[SPADE生成器G]
  H --> H5[缝合与重定向模块S&R]
  
  H1 --> I[输入处理]
  H2 --> I
  H3 --> I
  H4 --> I
  H5 --> I
  
  I --> I1[源输入处理]
  I --> I2[驱动输入处理]
  
  I1 -->|图像源| I1A[加载源图像]
  I1 -->|视频源| I1B[加载源视频]
  I2 -->|驱动视频| I2A[加载驱动视频]
  I2 -->|驱动图像| I2B[加载驱动图像]
  I2 -->|模板文件| I2C[加载模板文件]
  
  I1A --> J[裁剪操作]
  I1B --> J
  I2A --> J
  I2B --> J
  I2C -->|跳过裁剪| K[动作模板处理]
  
  J --> J1[源图像/视频裁剪]
  J --> J2[驱动视频裁剪]
  J1 --> K
  J2 --> K
  
  K -->|从视频提取| K1[生成动作模板]
  K -->|从模板加载| K2[加载动作模板]
  K1 --> K3[保存模板文件(.pkl)]
  K1 --> L[特征提取]
  K2 --> L
  
  L --> L1[提取源图像特征]
  L1 --> M[动画生成]
  
  M --> M1[计算关键点信息]
  M1 --> M2[计算旋转矩阵]
  M1 --> M3[计算表情参数]
  M1 --> M4[计算眼口比例]
  
  M2 --> N[运动处理]
  M3 --> N
  M4 --> N
  
  N -->|相对运动| N1[相对运动映射]
  N -->|绝对运动| N2[绝对运动映射]
  N1 --> N3[运动平滑]
  N2 --> N3
  
  N3 --> O[重定向控制]
  O --> O1[眼睛控制]
  O --> O2[嘴唇控制]
  
  O1 --> P[缝合处理]
  O2 --> P
  P -->|启用缝合| P1[缝合计算]
  P -->|不启用缝合| Q[图像生成]
  P1 --> Q
  
  Q --> Q1[变形操作(W)]
  Q1 --> Q2[SPADE生成(G)]
  
  Q2 --> R[后处理]
  R -->|启用贴回| R1[贴回操作]
  R -->|不启用贴回| R3[视频组合]
  R1 --> R3
  R -->|有音频| R2[音频处理]
  R2 --> R3
  
  R3 --> S[输出结果]
  S --> S1[生成视频]
  S --> S2[图像重定向结果]
  S --> S3[动作模板(.pkl)]
  
  S1 --> T[返回结果给用户]
  S2 --> T
  S3 --> T
